<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Minimal Preview Test</title>
  <link rel="stylesheet" href="css/styles.css"/>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
</head>
<body>
<div class="app">
  <div class="topbar">
    <h2>Minimal Preview Test</h2>
    <button id="testBtn" class="btn">Test Preview</button>
  </div>

  <div class="main" style="grid-template-columns: 1fr 1fr;">
    <div class="card">
      <h3 style="padding:12px;">Editor</h3>
      <div class="editor">
        <textarea id="editor" placeholder="Type markdown here...">
# Test Note

This is a **test** with *italic* text.

Try typing here: [[Link Test]] and #testtag

- List item 1
- List item 2

## Second heading

Some more content here.
        </textarea>
      </div>
      <div class="editor-status" id="editorStatus" style="padding: 4px 12px; border-top: 1px solid #1a2133; font-size: 11px; color: var(--muted); background: #0f1422;">
        <span>Words: 0</span> | <span>Chars: 0</span> | <span>Lines: 1</span> | <span>Tags: 0</span> | <span>Links: 0</span>
      </div>
    </div>

    <div class="card">
      <h3 style="padding:12px;">Preview</h3>
      <div id="preview" class="preview" style="height: 400px; overflow: auto;">
        Loading preview...
      </div>
    </div>
  </div>
</div>

<script>
// Simple utility functions
const el = (sel) => document.querySelector(sel);
const debounce = (fn, ms=300) => { 
  let t; 
  return (...a) => { 
    clearTimeout(t); 
    t = setTimeout(() => fn(...a), ms);
  }
};

// Enhanced markdown rendering with tag highlighting
const renderMD = (md) => {
  if (!md) return '';
  
  console.log('Rendering markdown:', md.substring(0, 50) + '...');
  
  try {
    // Use marked.js if available
    let html = '';
    if (typeof marked !== 'undefined') {
      html = DOMPurify.sanitize(marked.parse(md));
      console.log('Used marked.js for rendering');
    } else {
      // Fallback markdown rendering
      html = md
        .replace(/^# (.+)$/gm, '<h1>$1</h1>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/\n/g, '<br>');
      
      // Wrap list items
      html = html.replace(/(<li>.*?<\/li>)/gs, '<ul>$1</ul>');
      console.log('Used fallback markdown rendering');
    }
    
    // Enhanced wikilink rendering
    html = html.replace(/\[\[([^\]]+)\]\]/g, (m, p1) => {
      const t = p1.trim();
      const isIdLink = t.toLowerCase().startsWith('id:');
      const linkClass = isIdLink ? 'link id-link' : 'link title-link';
      return `<a class="${linkClass}" href="#" onclick="console.log('Clicked link: ${t}')" title="Open: ${t}">[[${t}]]</a>`;
    });
    
    // Enhanced tag rendering with dynamic colors
    html = html.replace(/(^|\s)#([a-z0-9_\-]+)/gi, (match, prefix, tag) => {
      const colors = ['#6ee7ff', '#9a7cff', '#00d18f', '#ffd166', '#ef476f', '#06d6a0', '#118ab2'];
      const color = colors[tag.length % colors.length];
      
      return `${prefix}<span class="tag enhanced-tag" style="
        background: ${color}20;
        border: 1px solid ${color};
        border-radius: 12px;
        padding: 3px 8px;
        color: ${color};
        font-weight: 500;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
      " onclick="console.log('Clicked tag: #${tag}')" title="Filter by #${tag}">#${tag}</span>`;
    });
    
    console.log('Markdown rendered successfully');
    return html;
    
  } catch (error) {
    console.error('Markdown rendering error:', error);
    return `<div style="color: red;">Rendering error: ${error.message}</div>`;
  }
};

// Live preview function
const updatePreview = () => {
  const editor = el('#editor');
  const preview = el('#preview');
  
  if (!editor || !preview) {
    console.error('Editor or preview elements not found');
    return;
  }
  
  const content = editor.value;
  console.log('Updating preview, content length:', content.length);
  
  // Update preview
  const rendered = renderMD(content);
  preview.innerHTML = rendered;
  
  // Update stats
  const words = content.trim() ? content.trim().split(/\s+/).length : 0;
  const chars = content.length;
  const lines = content.split('\n').length;
  const tags = (content.match(/#[a-z0-9_\-]+/gi) || []).length;
  const links = (content.match(/\[\[([^\]]+)\]\]/g) || []).length;
  
  const statusArea = el('#editorStatus');
  if (statusArea) {
    statusArea.innerHTML = `
      <span>Words: ${words}</span> | 
      <span>Chars: ${chars}</span> | 
      <span>Lines: ${lines}</span> | 
      <span>Tags: ${tags}</span> | 
      <span>Links: ${links}</span>
    `;
  }
  
  console.log('Preview updated successfully');
};

// Debounced version for performance
const updatePreviewDebounced = debounce(updatePreview, 50);

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  console.log('DOM loaded, initializing preview test...');
  
  const editor = el('#editor');
  const testBtn = el('#testBtn');
  
  if (editor) {
    // Add event listeners
    editor.addEventListener('input', () => {
      console.log('Editor input detected');
      updatePreviewDebounced();
    });
    
    editor.addEventListener('paste', () => {
      console.log('Editor paste detected');
      setTimeout(updatePreview, 10);
    });
    
    // Initial render
    setTimeout(() => {
      console.log('Performing initial preview render');
      updatePreview();
    }, 100);
    
    console.log('Event listeners attached successfully');
  } else {
    console.error('Editor element not found');
  }
  
  if (testBtn) {
    testBtn.onclick = () => {
      console.log('Test button clicked, forcing preview update');
      updatePreview();
    };
  }
  
  console.log('Minimal preview test initialized');
});
</script>

</body>
</html>