<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mahart Linked Notes - WORKING VERSION</title>
  <link rel="stylesheet" href="css/styles.css"/>
  <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
</head>
<body>
<div class="app">
  <div class="topbar">
    <button id="newNote" class="btn">New Note</button>
    <button id="saveNote" class="btn">Save</button>
    <input id="q" type="search" placeholder="Search..." style="flex: 1; margin: 0 8px;"/>
    <button id="exportBtn" class="btn">Export</button>
  </div>

  <div class="left">
    <div class="section">
      <strong>Notes</strong> <span id="noteCount" class="badge">0</span>
      <div id="noteList"></div>
    </div>
  </div>

  <div class="main">
    <div class="card">
      <h3 style="padding:12px;">Editor <span id="dirty" class="badge" style="display:none;">unsaved</span></h3>
      <div class="editor">
        <textarea id="editor" placeholder="Type your note here..."></textarea>
      </div>
      <div class="meta">
        <input id="title" placeholder="Note title"/>
        <button id="saveNoteInline" class="btn">Save</button>
      </div>
      <div id="editorStatus" style="padding: 4px 12px; border-top: 1px solid #1a2133; font-size: 11px; color: var(--muted);">
        Words: 0 | Chars: 0 | Lines: 1
      </div>
    </div>

    <div class="card">
      <h3 style="padding:12px;">Preview</h3>
      <div id="preview" class="preview"></div>
    </div>
  </div>

  <div class="right">
    <div class="panel small">
      <strong>Status</strong>
      <div id="status">Ready</div>
    </div>
  </div>
</div>

<div id="toast" class="toast">Saved</div>

<script>
// ESSENTIAL UTILITIES ONLY
const el = (sel) => document.querySelector(sel);
const ULID = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
const nowISO = () => new Date().toISOString();
const debounce = (fn, ms=300) => { let t; return (...a) => { clearTimeout(t); t=setTimeout(()=>fn(...a), ms)}};
const toast = (msg) => { const t=el('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200); }

// MARKDOWN RENDERING
const renderMD = (md) => {
  if (!md) return '';
  
  try {
    let html = marked.parse(md);
    html = DOMPurify.sanitize(html);
    
    // Enhanced wikilink rendering
    html = html.replace(/\[\[([^\]]+)\]\]/g, '<a class="link" href="#" onclick="openWikiLink(\'$1\')">[[$1]]</a>');
    
    // Enhanced tag rendering
    html = html.replace(/(^|\s)#([a-z0-9_\-]+)/gi, '$1<span class="tag" style="background: #6ee7ff20; border: 1px solid #6ee7ff; color: #6ee7ff; padding: 2px 6px; border-radius: 12px; cursor: pointer;">#$2</span>');
    
    return html;
  } catch (error) {
    console.error('Markdown error:', error);
    return md.replace(/\n/g, '<br>');
  }
};

// SIMPLE STORE
const Store = {
  async allNotes() { return (await localforage.getItem('notes')) || []; },
  async saveNotes(arr) { await localforage.setItem('notes', arr); return arr; },
  async upsert(note) {
    const ns = await this.allNotes();
    const i = ns.findIndex(n => n.id === note.id);
    if (i >= 0) ns[i] = note; else ns.push(note);
    await this.saveNotes(ns);
    return note;
  },
  async get(id) { return (await this.allNotes()).find(n => n.id === id); }
};

// NOTE MODEL
const Note = {
  create({title='', body='', tags=[]} = {}) {
    return { 
      id: ULID(), 
      title, 
      body, 
      tags, 
      links: [], 
      createdAt: nowISO(), 
      updatedAt: nowISO() 
    };
  }
};

// MAIN APP
const App = {
  currentId: null,
  
  async init() {
    console.log('Initializing app...');
    this.bind();
    await this.refresh();
    
    // Auto-open first note or create one
    const notes = await Store.allNotes();
    if (notes.length === 0) {
      await this.newNote();
    } else {
      await this.openNote(notes[0].id);
    }
    
    console.log('App initialized successfully');
  },
  
  bind() {
    const editor = el('#editor');
    const title = el('#title');
    
    if (editor) {
      editor.addEventListener('input', () => {
        console.log('Editor input - updating preview');
        this.updatePreview();
        this.updateStats();
        const dirty = el('#dirty');
        if (dirty) dirty.style.display = 'inline-block';
      });
    }
    
    if (title) {
      title.addEventListener('input', () => {
        const dirty = el('#dirty');
        if (dirty) dirty.style.display = 'inline-block';
      });
    }
    
    const newBtn = el('#newNote');
    if (newBtn) newBtn.onclick = () => this.newNote();
    
    const saveBtn = el('#saveNote');
    if (saveBtn) saveBtn.onclick = () => this.save();
    
    const saveInlineBtn = el('#saveNoteInline');
    if (saveInlineBtn) saveInlineBtn.onclick = () => this.save();
    
    const exportBtn = el('#exportBtn');
    if (exportBtn) exportBtn.onclick = () => this.export();
  },
  
  updatePreview() {
    const editor = el('#editor');
    const preview = el('#preview');
    
    if (!editor || !preview) return;
    
    const content = editor.value;
    const rendered = renderMD(content);
    preview.innerHTML = rendered;
    
    console.log('Preview updated');
  },
  
  updateStats() {
    const editor = el('#editor');
    const status = el('#editorStatus');
    
    if (!editor || !status) return;
    
    const content = editor.value;
    const words = content.trim() ? content.trim().split(/\s+/).length : 0;
    const chars = content.length;
    const lines = content.split('\n').length;
    
    status.innerHTML = `Words: ${words} | Chars: ${chars} | Lines: ${lines}`;
  },
  
  async refresh() {
    const notes = await Store.allNotes();
    this.renderList(notes);
  },
  
  renderList(notes) {
    const box = el('#noteList');
    if (!box) return;
    
    box.innerHTML = '';
    const sorted = [...notes].sort((a,b) => (b.updatedAt||'').localeCompare(a.updatedAt||''));
    
    for (const n of sorted) {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<div style="padding:6px 4px;cursor:pointer">
        <div>${n.title || '(untitled)'}</div>
        <div class="small">${(n.updatedAt||n.createdAt).slice(0,16).replace('T',' ')}</div>
      </div>`;
      div.onclick = () => this.openNote(n.id);
      box.appendChild(div);
    }
    
    const noteCount = el('#noteCount');
    if (noteCount) noteCount.textContent = notes.length;
  },
  
  async openNote(id) {
    const n = await Store.get(id);
    if (!n) return;
    
    this.currentId = n.id;
    const title = el('#title');
    const editor = el('#editor');
    const dirty = el('#dirty');
    
    if (title) title.value = n.title || '';
    if (editor) editor.value = n.body || '';
    if (dirty) dirty.style.display = 'none';
    
    this.updatePreview();
    this.updateStats();
    
    console.log('Opened note:', n.title);
  },
  
  async newNote() {
    const n = Note.create({ title: 'New Note', body: '# New Note\n\nStart writing here...' });
    await Store.upsert(n);
    await this.openNote(n.id);
    await this.refresh();
    console.log('Created new note');
  },
  
  async save() {
    if (!this.currentId) {
      await this.newNote();
      return;
    }
    
    const n = await Store.get(this.currentId);
    const title = el('#title');
    const editor = el('#editor');
    
    if (title) n.title = title.value.trim() || n.title || '(untitled)';
    if (editor) n.body = editor.value;
    n.updatedAt = nowISO();
    
    await Store.upsert(n);
    
    const dirty = el('#dirty');
    if (dirty) dirty.style.display = 'none';
    
    toast('Saved');
    await this.refresh();
    console.log('Saved note');
  },
  
  async export() {
    const notes = await Store.allNotes();
    const data = { notes, exportedAt: nowISO() };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), {href: url, download: `notes-${Date.now()}.json`});
    a.click();
    URL.revokeObjectURL(url);
    toast('Exported');
  }
};

// Global functions
window.openWikiLink = (link) => {
  console.log('Wiki link clicked:', link);
  toast('Wiki link: ' + link);
};

// INITIALIZE
document.addEventListener('DOMContentLoaded', () => App.init());
</script>

</body>
</html>