<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Text Highlighting Test</title>
  <link rel="stylesheet" href="css/styles.css"/>
</head>
<body>
<div class="app" style="grid-template-columns: 1fr 1fr; grid-template-areas: 'main main';">
  <div class="main" style="grid-area: main;">
    <div class="card">
      <h3 style="padding:12px;">Test Editor - Select text to highlight</h3>
      <div class="editor">
        <textarea id="editor" placeholder="Type text here and select it to test highlighting...">
# Test Document

This is a ==red:test of red highlighting== and this is ==blue:blue highlighted text==.

You can also have ==green:green text== and ==purple:purple text==.

Try selecting any text in this editor to test the highlighting feature!

## Features
- **Bold text** with ==yellow:yellow highlights==
- *Italic text* with ==orange:orange highlights==
- Regular text with ==cyan:cyan highlights==
- Regular text with ==pink:pink highlights==

#testtag #highlighting #feature
        </textarea>
      </div>
    </div>

    <div class="card">
      <h3 style="padding:12px;">Live Preview</h3>
      <div id="preview" class="preview"></div>
    </div>
  </div>
</div>

<!-- Color Picker Menu -->
<div id="colorPickerMenu" class="color-picker-menu">
  <div class="color-picker-header">Text Highlighting</div>
  <div class="color-picker-grid">
    <div class="color-option color-option-red" data-color="red" title="Red">R</div>
    <div class="color-option color-option-orange" data-color="orange" title="Orange">O</div>
    <div class="color-option color-option-yellow" data-color="yellow" title="Yellow">Y</div>
    <div class="color-option color-option-green" data-color="green" title="Green">G</div>
    <div class="color-option color-option-blue" data-color="blue" title="Blue">B</div>
    <div class="color-option color-option-purple" data-color="purple" title="Purple">P</div>
    <div class="color-option color-option-pink" data-color="pink" title="Pink">K</div>
    <div class="color-option color-option-cyan" data-color="cyan" title="Cyan">C</div>
  </div>
  <div class="color-picker-actions">
    <button class="color-picker-btn remove" id="removeHighlight">Remove</button>
    <button class="color-picker-btn" id="cancelHighlight">Cancel</button>
  </div>
</div>

<div id="toast" class="toast">Saved</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

<script>
// Utility functions
const el = (sel) => document.querySelector(sel);
const els = (sel) => Array.from(document.querySelectorAll(sel));
const toast = (msg) => {const t=el('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200);}

// Text Highlighting System
const TextHighlighter = {
  currentSelection: null,
  
  init() {
    this.bindEvents();
  },
  
  bindEvents() {
    const editor = el('#editor');
    const colorPicker = el('#colorPickerMenu');
    const colorOptions = els('.color-option');
    const removeBtn = el('#removeHighlight');
    const cancelBtn = el('#cancelHighlight');
    
    // Show color picker on text selection
    if (editor) {
      editor.addEventListener('mouseup', (e) => {
        setTimeout(() => this.handleTextSelection(e), 10);
      });
      
      editor.addEventListener('keyup', (e) => {
        if (e.key === 'ArrowLeft' || e.key === 'ArrowRight' || e.key === 'ArrowUp' || e.key === 'ArrowDown') {
          setTimeout(() => this.handleTextSelection(e), 10);
        }
      });
    }
    
    // Color option clicks
    colorOptions.forEach(option => {
      option.addEventListener('click', () => {
        const color = option.dataset.color;
        this.applyHighlight(color);
      });
    });
    
    // Remove highlight
    if (removeBtn) {
      removeBtn.addEventListener('click', () => {
        this.removeHighlight();
      });
    }
    
    // Cancel
    if (cancelBtn) {
      cancelBtn.addEventListener('click', () => {
        this.hideColorPicker();
      });
    }
    
    // Hide picker on outside click
    document.addEventListener('click', (e) => {
      if (!colorPicker.contains(e.target) && !editor.contains(e.target)) {
        this.hideColorPicker();
      }
    });
  },
  
  handleTextSelection(e) {
    const editor = el('#editor');
    const start = editor.selectionStart;
    const end = editor.selectionEnd;
    const selectedText = editor.value.substring(start, end).trim();
    
    if (selectedText && start !== end) {
      this.currentSelection = {
        text: selectedText,
        start: start,
        end: end
      };
      this.showColorPicker(e);
      console.log('Text selected:', selectedText);
    } else {
      this.hideColorPicker();
    }
  },
  
  showColorPicker(e) {
    const colorPicker = el('#colorPickerMenu');
    const editor = el('#editor');
    const editorRect = editor.getBoundingClientRect();
    
    colorPicker.style.display = 'block';
    
    // Position relative to editor, not mouse
    const x = Math.min(e.clientX, editorRect.right - 200);
    const y = Math.min(e.clientY + 20, window.innerHeight - 120);
    
    colorPicker.style.left = `${x}px`;
    colorPicker.style.top = `${y}px`;
    
    console.log('Color picker shown at', x, y);
  },
  
  hideColorPicker() {
    const colorPicker = el('#colorPickerMenu');
    colorPicker.style.display = 'none';
    this.currentSelection = null;
  },
  
  applyHighlight(color) {
    if (!this.currentSelection) return;
    
    const editor = el('#editor');
    const content = editor.value;
    const { start, end, text } = this.currentSelection;
    
    // Create highlight syntax: ==color:text==
    const highlightedText = `==${color}:${text}==`;
    
    // Replace selected text with highlighted version
    const newContent = content.substring(0, start) + highlightedText + content.substring(end);
    editor.value = newContent;
    
    // Update cursor position
    const newCursorPos = start + highlightedText.length;
    editor.setSelectionRange(newCursorPos, newCursorPos);
    
    // Trigger change events
    editor.dispatchEvent(new Event('input'));
    
    this.hideColorPicker();
    toast(`Applied ${color} highlight`);
  },
  
  removeHighlight() {
    if (!this.currentSelection) return;
    
    const editor = el('#editor');
    const content = editor.value;
    const { start, end } = this.currentSelection;
    
    // Look for highlight pattern around selection
    const highlightPattern = /==(\w+):([^=]+)==/g;
    let match;
    let found = false;
    
    while ((match = highlightPattern.exec(content)) !== null) {
      const matchStart = match.index;
      const matchEnd = match.index + match[0].length;
      
      if (start >= matchStart && end <= matchEnd) {
        // Remove the highlight syntax, keep just the text
        const plainText = match[2];
        const newContent = content.substring(0, matchStart) + plainText + content.substring(matchEnd);
        editor.value = newContent;
        
        // Update cursor position
        const newCursorPos = matchStart + plainText.length;
        editor.setSelectionRange(newCursorPos, newCursorPos);
        
        found = true;
        break;
      }
    }
    
    if (found) {
      editor.dispatchEvent(new Event('input'));
      toast('Removed highlight');
    } else {
      toast('No highlight found');
    }
    
    this.hideColorPicker();
  }
};

// Markdown rendering with highlights
function renderMarkdownWithHighlights(md) {
  if (!md) return '';
  
  try {
    // First process highlights before markdown
    let processedMd = md;
    
    // Convert highlight syntax ==color:text== to HTML spans
    processedMd = processedMd.replace(/==(\w+):([^=]+)==/g, (match, color, text) => {
      return `<span class="highlight-${color}">${text}</span>`;
    });
    
    // Use marked.js for markdown parsing
    let html = '';
    if (typeof marked !== 'undefined') {
      html = DOMPurify.sanitize(marked.parse(processedMd));
    } else {
      // Fallback markdown rendering
      html = processedMd
        .replace(/^# (.+)$/gm, '<h1>$1</h1>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/\n/g, '<br>');
      
      // Wrap list items
      html = html.replace(/(<li>.*?<\/li>)/gs, '<ul>$1</ul>');
    }
    
    // Enhanced tag rendering
    html = html.replace(/(^|\s)#([a-z0-9_\-]+)/gi, (match, prefix, tag) => {
      const colors = ['#6ee7ff', '#9a7cff', '#00d18f', '#ffd166', '#ef476f', '#06d6a0', '#118ab2'];
      const color = colors[tag.length % colors.length];
      
      return `${prefix}<span class="tag enhanced-tag" style="
        background: ${color}20;
        border: 1px solid ${color};
        border-radius: 12px;
        padding: 3px 8px;
        color: ${color};
        font-weight: 500;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
      " onclick="console.log('Clicked tag: #${tag}')" title="Filter by #${tag}">#${tag}</span>`;
    });
    
    return html;
    
  } catch (error) {
    console.error('Markdown rendering error:', error);
    return `<div style="color: red;">Rendering error: ${error.message}</div>`;
  }
}

// Live preview update
function updatePreview() {
  const editor = el('#editor');
  const preview = el('#preview');
  
  if (!editor || !preview) return;
  
  const content = editor.value;
  const rendered = renderMarkdownWithHighlights(content);
  preview.innerHTML = rendered;
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  TextHighlighter.init();
  
  const editor = el('#editor');
  if (editor) {
    editor.addEventListener('input', updatePreview);
    updatePreview(); // Initial render
  }
});
</script>

</body>
</html>