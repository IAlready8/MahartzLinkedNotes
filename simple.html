<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Mahart Notes</title>
    <link rel="stylesheet" href="css/styles.css"/>
    <style>
        body { margin: 0; background: #0f1115; color: #e7ecf5; font-family: system-ui, sans-serif; }
        .app { display: grid; grid-template-columns: 300px 1fr; grid-template-rows: 48px 1fr; grid-template-areas: "top top" "left main"; height: 100vh; }
        .topbar { grid-area: top; display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #151922; }
        .left { grid-area: left; border-right: 1px solid #1f2434; background: #151922; overflow: auto; }
        .main { grid-area: main; padding: 8px; }
        .section { padding: 12px; border-bottom: 1px solid #1f2434; }
        .card { background: #0b0f18; border: 1px solid #1a2133; border-radius: 14px; overflow: hidden; display: flex; flex-direction: column; height: 100%; }
        .card-header { padding: 12px; border-bottom: 1px solid #1a2133; background: #0f1422; }
        .editor-container { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; height: 100%; }
        .editor, .preview { overflow: auto; padding: 12px; }
        .editor textarea { width: 100%; height: 100%; background: transparent; border: none; color: #e7ecf5; outline: none; resize: none; font: 14px/1.5 ui-monospace, monospace; }
        .meta { display: flex; gap: 8px; padding: 8px; border-top: 1px solid #1a2133; }
        .meta input { flex: 1; background: #0b0e14; border: 1px solid #1f2434; border-radius: 8px; color: #e7ecf5; padding: 8px; }
        .btn { background: #1b2130; border: 1px solid #2a3147; border-radius: 10px; color: #d7def0; padding: 8px 12px; cursor: pointer; }
        .btn:hover { border-color: #3a4563; }
        .badge { background: #121829; border: 1px solid #243053; color: #a8b3ce; padding: 2px 6px; border-radius: 6px; margin-left: 6px; font-size: 12px; }
        .tag { display: inline-block; background: #111624; border: 1px solid #232c44; color: #a8b3ce; padding: 3px 8px; border-radius: 999px; margin: 2px; font-size: 12px; cursor: pointer; }
        .item { padding: 6px 4px; cursor: pointer; border-bottom: 1px solid #1f2434; }
        .item:hover { background: #111624; }
        .small { font-size: 12px; color: #8b93a5; }
    </style>
</head>
<body>
    <div class="app">
        <div class="topbar">
            <button id="newNote" class="btn">New Note</button>
            <button id="saveNote" class="btn">Save</button>
            <input id="q" type="search" placeholder="Search notes..."/>
        </div>

        <div class="left">
            <div class="section">
                <div><strong>Notes</strong> <span id="noteCount" class="badge">0</span></div>
                <div id="noteList"></div>
            </div>
            <div class="section">
                <div><strong>Tags</strong> <span id="tagCount" class="badge">0</span></div>
                <div id="tagList"></div>
            </div>
        </div>

        <div class="main">
            <div class="card">
                <div class="card-header">
                    <h3>Editor</h3>
                    <span id="dirty" class="badge" style="display:none;">unsaved</span>
                </div>
                <div class="editor-container">
                    <div class="editor">
                        <textarea id="editor" placeholder="Write your note here..."></textarea>
                    </div>
                    <div class="preview">
                        <div id="preview"></div>
                    </div>
                </div>
                <div class="meta">
                    <input id="title" placeholder="Note title"/>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Simple utility functions
        const el = (sel) => document.querySelector(sel);
        const els = (sel) => document.querySelectorAll(sel);
        
        // Simple ID generator
        const ULID = () => Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        
        // Simple nowISO function
        const nowISO = () => new Date().toISOString();
        
        // Simple debounce function
        const debounce = (fn, ms) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); }; };
        
        // Simple storage using localStorage as fallback
        const Storage = {
            async allNotes() {
                try {
                    if (typeof localforage !== 'undefined') {
                        return (await localforage.getItem('notes')) || [];
                    }
                    return JSON.parse(localStorage.getItem('mahart-notes') || '[]');
                } catch (e) {
                    return [];
                }
            },
            async saveNotes(notes) {
                try {
                    if (typeof localforage !== 'undefined') {
                        await localforage.setItem('notes', notes);
                    } else {
                        localStorage.setItem('mahart-notes', JSON.stringify(notes));
                    }
                    return notes;
                } catch (e) {
                    console.error('Failed to save notes:', e);
                    return notes;
                }
            },
            async upsert(note) {
                const notes = await this.allNotes();
                const index = notes.findIndex(n => n.id === note.id);
                if (index >= 0) {
                    notes[index] = note;
                } else {
                    notes.push(note);
                }
                await this.saveNotes(notes);
                return note;
            },
            async get(id) {
                const notes = await this.allNotes();
                return notes.find(n => n.id === id) || null;
            }
        };
        
        // Simple app state
        const App = {
            currentNote: null,
            
            async init() {
                console.log('Initializing Simple Mahart Notes...');
                
                // Bind events
                this.bind();
                
                // Refresh UI
                await this.refresh();
                
                // Open first note or create new one
                const notes = await Storage.allNotes();
                if (notes.length > 0) {
                    this.openNote(notes[0].id);
                } else {
                    this.newNote();
                }
            },
            
            bind() {
                el('#newNote').onclick = () => this.newNote();
                el('#saveNote').onclick = () => this.saveNote();
                el('#editor').addEventListener('input', () => {
                    el('#dirty').style.display = 'inline-block';
                    this.renderPreview();
                });
                el('#title').addEventListener('input', () => {
                    el('#dirty').style.display = 'inline-block';
                });
                el('#q').addEventListener('input', debounce((e) => this.search(e.target.value), 300));
            },
            
            async refresh() {
                const notes = await Storage.allNotes();
                this.renderNotesList(notes);
                this.renderTagsList(notes);
            },
            
            renderNotesList(notes) {
                const container = el('#noteList');
                if (!container) return;
                container.innerHTML = '';
                
                // Sort by updated date
                const sorted = [...notes].sort((a, b) => (b.updatedAt || b.createdAt).localeCompare(a.updatedAt || a.createdAt));
                
                sorted.forEach(note => {
                    const div = document.createElement('div');
                    div.className = 'item';
                    div.innerHTML = `
                        <div>${note.title || '(untitled)'}</div>
                        <div class="small">${new Date(note.updatedAt || note.createdAt).toLocaleString()}</div>
                    `;
                    div.onclick = () => this.openNote(note.id);
                    container.appendChild(div);
                });
                
                const noteCount = el('#noteCount');
                if (noteCount) noteCount.textContent = notes.length;
            },
            
            renderTagsList(notes) {
                const container = el('#tagList');
                if (!container) return;
                container.innerHTML = '';
                
                // Collect all tags
                const tagCounts = {};
                notes.forEach(note => {
                    (note.tags || []).forEach(tag => {
                        tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                    });
                });
                
                // Sort by count
                const sortedTags = Object.entries(tagCounts)
                    .sort((a, b) => b[1] - a[1]);
                
                sortedTags.forEach(([tag, count]) => {
                    const span = document.createElement('span');
                    span.className = 'tag';
                    span.textContent = `${tag} (${count})`;
                    span.onclick = () => this.filterByTag(tag);
                    container.appendChild(span);
                });
                
                const tagCount = el('#tagCount');
                if (tagCount) tagCount.textContent = sortedTags.length;
            },
            
            renderPreview() {
                const editor = el('#editor');
                const preview = el('#preview');
                if (!editor || !preview) return;
                
                const content = editor.value;
                // Simple markdown rendering
                let html = content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/# (.*?)(\n|$)/g, '<h1>$1</h1>')
                    .replace(/## (.*?)(\n|$)/g, '<h2>$1</h2>')
                    .replace(/\[\[(.*?)\]\]/g, '<a href="#" style="color:#6ee7ff;text-decoration:none;border-bottom:1px dashed #6ee7ff;">$1</a>')
                    .replace(/#(\w+)/g, '<span style="background:#6ee7ff15;border:1px solid #6ee7ff;border-radius:4px;padding:0 4px;color:#6ee7ff;">#$1</span>')
                    .replace(/\n/g, '<br>');
                
                preview.innerHTML = html;
            },
            
            async newNote() {
                const note = {
                    id: ULID(),
                    title: '',
                    body: '',
                    tags: [],
                    links: [],
                    createdAt: nowISO(),
                    updatedAt: nowISO()
                };
                await Storage.upsert(note);
                this.openNote(note.id);
                await this.refresh();
            },
            
            async openNote(id) {
                const note = await Storage.get(id);
                if (!note) return;
                
                this.currentNote = note;
                const title = el('#title');
                const editor = el('#editor');
                const dirty = el('#dirty');
                
                if (title) title.value = note.title || '';
                if (editor) editor.value = note.body || '';
                if (dirty) dirty.style.display = 'none';
                this.renderPreview();
            },
            
            async saveNote() {
                if (!this.currentNote) return;
                
                const title = el('#title');
                const editor = el('#editor');
                const dirty = el('#dirty');
                
                if (title) this.currentNote.title = title.value || '(untitled)';
                if (editor) this.currentNote.body = editor.value;
                this.currentNote.updatedAt = nowISO();
                
                await Storage.upsert(this.currentNote);
                if (dirty) dirty.style.display = 'none';
                
                // Show save confirmation
                const saveBtn = el('#saveNote');
                const originalText = saveBtn.textContent;
                saveBtn.textContent = 'Saved!';
                setTimeout(() => {
                    saveBtn.textContent = originalText;
                }, 1000);
                
                await this.refresh();
            },
            
            async search(query) {
                const notes = await Storage.allNotes();
                if (!query.trim()) {
                    this.renderNotesList(notes);
                    return;
                }
                
                const filtered = notes.filter(note => 
                    (note.title && note.title.toLowerCase().includes(query.toLowerCase())) ||
                    (note.body && note.body.toLowerCase().includes(query.toLowerCase())) ||
                    (note.tags && note.tags.some(tag => tag.toLowerCase().includes(query.toLowerCase())))
                );
                
                this.renderNotesList(filtered);
            },
            
            async filterByTag(tag) {
                const notes = await Storage.allNotes();
                const filtered = notes.filter(note => 
                    note.tags && note.tags.includes(tag)
                );
                this.renderNotesList(filtered);
            }
        };
        
        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
</body>
</html>